<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="iron-swipeable-container2.html">
<link rel="import" href="toast-icons.html">

<!--
`app-toast`
A swipeable, actionable, and themable paper-toast.

Custom property | Description
----------------|-------------
`--app-toast` | Mixin applied to the internal paper-toast.
`--app-toast-button` | Mixin applied to the action button.
`--app-toast-main-icon` | Mixin applied to the main iron-icon.
`--app-toast-main-icon-stroke-color` | The stroke color of the main icon.
`--app-toast-cancel-icon` | Mixin applied to the cancel iron-icon.

@demo demo/index.html
-->

<dom-module id="app-toast">
  <template>
    <style>
      :host {
        display: block;
      }
      :host:not([disable-swipe]) iron-swipeable-container2 {
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
        user-select: none;
        cursor: default;
      }
      paper-toast {
        @apply --paper-font-body2;
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --app-toast;
      }
      .content-container {
        @apply --layout-flex;
        @apply --layout-vertical;
      }
      paper-button {
        color: var(--accent-color);
        @apply --app-toast-button;
      }
      #mainIcon {
        margin-right: 4px;
        @apply --app-toast-main-icon;
        --iron-icon-stroke-color: var(--app-toast-main-icon-stroke-color);
      }
      #cancelIcon {
        --iron-icon-height: 14px;
        --iron-icon-width: 14px;
        /*vertical-align: super;*/
        margin-left: 2px;
        padding: 2px;
        @apply --app-toast-cancel-icon;
      }
    </style>

    <div id="container">
      <iron-swipeable-container2
        id="swiper"
        disabled="[[disableSwipe]]"
        on-iron-swipe="__onSwiped">
        <paper-toast
          id="toast"
          duration="[[duration]]"
          on-tap="__onTap"
          on-iron-overlay-closed="__onClosed">

          <iron-icon
            id="mainIcon"
            icon="[[_getIcon(iconset, icon)]]"
            src="[[src]]"
            hidden$="[[_hideIcon(icon, src)]]">
          </iron-icon>

          <div class="content-container">
            <slot></slot>
            <span>[[text]]</span>
          </div>

          <paper-button
            id="actionButton"
            on-tap="_action1Tapped"
            hidden$="[[!actionText]]">
            [[actionText]]
          </paper-button>

          <paper-button
            id="action2Button"
            on-tap="_action2Tapped"
            hidden$="[[!action2Text]]">
            [[action2Text]]
          </paper-button>

          <iron-icon
            id="cancelIcon"
            icon="toast-icons:close"
            on-tap="_cancelTapped"
            hidden$="[[!showCancel]]">
          </iron-icon>
        </paper-toast>
      </iron-swipeable-container2>
    </div>


  </template>
  <script>
    class AppToast extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'app-toast'; }
      static get properties() {
        return {
          /**
          * The src of the main iron-icon.
          */
          src: String,
          /**
          * The icon to use from the iconset.
          */
          icon: {
            type: String,
            value: ''
          },

          /**
          * The iconset to use for icons.
          */
          iconset: {
            type: String,
            value: 'toast-icons'
          },

          /**
          * The toast's text.
          */
          text: String,

          /**
          * The duration in milliseconds to show the toast.
          */
          duration: {
            type: Number,
            value: 3000
          },

          /**
          * The text of the action button.
          */
          actionText: {
            type: String,
            value: ''
          },

          /**
          * The text of the action2 button.
          */
          action2Text: {
            type: String,
            value: ''
          },

          /**
          * @deprecated use corresponding `show`/`open` argument.
          *
          * The callback for the action button.
          */
          onAction1: {
            type: Object,
            value: null
          },

          /**
          * @deprecated use corresponding `show`/`open` argument.
          *
          * The callback for the action2 button.
          */
          onAction2: {
            type: Object,
            value: null
          },

          /**
          * @deprecated use corresponding `show`/`open` argument.
          *
          * Called when the toast is canceled by the user by either swiping or
          * using the close icon.
          */
          onCancel: {
            type: Object,
            value: null
          },

          /**
          * @deprecated use corresponding `show`/`open` argument.
          *
          * Called when the toast is tapped, excludes action and cancel buttons.
          */
          onTapped: {
            type: Object,
            value: null
          },

          /**
          * Whether to show the cancel icon.
          */
          showCancel: {
            type: Boolean,
            value: false
          },

          /**
          * Whether the toast should stretch across the bottom of its container.
          */
          fitBottom: {
            type: Boolean,
            value: false,
            observer: '_fitBottomChanged'
          },

          /**
          * Whether swiping should be disabled.
          */
          disableSwipe: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          }
        };
      }

      connectedCallback() {
        this._defaultProperties = {
          icon: this.icon,
          iconset: this.iconset,
          text: this.text,
          duration: this.duration,
          actionText: this.actionText,
          action2Text: this.action2Text,
          onAction1: this.onAction1,
          onAction2: this.onAction2,
          onCancel: this.onCancel,
          onTapped: this.onTapped,
          showCancel: this.showCancel,
          fitBottom: this.fitBottom,
          disableSwipe: this.disableSwipe,
        };
      }

      /**
       * @deprecated
       *
       * Reset properties to what they were when this element
       * was last attached/connected.
       */
      reset() {
        this._setProperties(this._defaultProperties);
      }

      /**
       * Set the specified set of properties and show the toast.
       * The properties object can contain properties of this element
       * and the underlying paper-toast.
       */
      show(properties, onTap, onAction1, onAction2, onCancel) {
        this._setProperties(properties);
        this.onTap = onTap;
        this.onAction1 = onAction1;
        this.onAction2 = onAction2;
        this.onCancel = onCancel;
        this.$.toast.style.opacity = 1;
        this.$.toast.show(properties);
      }

      /**
       * Alias for `show()`
       */
      open(properties, onTap, onAction1, onAction2, onCancel) {
        this.show(properties, onTap, onAction1, onAction2, onCancel);
      }

      /**
       * Close the toast programatically.
       */
      close() {
        this.$.toast.close();
      }

      _cancelTapped(e) {
        e.stopPropagation(); // removing this does not fix issue #1
        this._cancel(e);
      }

      _cancel(e) {
        // console.log('canceled.');
        this.$.toast.close();
        // this.$.toast.style.opacity = 0; // (not) Fix for #1 close button fails after partial swipe
        this.onCancel && this.onCancel(e);
        this._fire('toast-cancel');
      }


      _action1Tapped(e) {
        e.stopPropagation();
        this.onAction1 && this.onAction1(e);
        this._fire('toast-action');
      }

      _action2Tapped(e) {
        e.stopPropagation();
        this.onAction2 && this.onAction2(e);
        this._fire('toast-action2');
      }

      _fitBottomChanged(fitBottom) {
        if (fitBottom) {
          this.$.toast.classList.add('fit-bottom');
        } else {
          this.$.toast.classList.remove('fit-bottom');
        }
      }

      _setProperties(properties) {
        if (properties) {
          for (var property in properties) {
            if (property in this && property.indexOf('_') != 0) {
              this[property] = properties[property];
              delete properties[property];
            }
          }
        }
      }

      _getIcon(iconset, icon) {
        return (iconset && icon) ? iconset +':'+ icon : '';
      }

      _hideIcon(icon, src) {
        return !(icon || src);
      }

      __onSwiped(e, data) {
        // console.log('swiped:');
        this.$.toast.style.opacity = 0;
        this._wasSwiped = true;
        this.close();
      }

      __onClosed(e, data) {
        // console.log('overlay closed:', data);
        if (this._wasSwiped) {
          this._cancel(e);
          this._wasSwiped = false;
        }
        this.$.toast.style.transform = 'translate3d(0, 0, 0) rotate(0)';
      }

      __onTap(e) {
        // console.log('tapped', e);
        this.onTapped && this.onTapped(e);
        this._fire('toast-tap');
      }



      /** Copy the Polymer 1.x fire implementation. */
      _fire(name, data, options = {}) {
        options.detail = data;
        if (options.bubbles === undefined) options.bubbles = true;
        if (options.composed === undefined) options.composed = true;
        this.dispatchEvent(new CustomEvent(name, options));
      }

      /**
       * Triggered when the paper-toast is tapped.
       *
       * @event toast-tap
       */
      /**
       * Triggered when the paper-toast is canceled.
       *
       * @event toast-cancel
       */
      /**
       * Triggered when the action button is tapped.
       *
       * @event toast-action
       */
      /**
       * Triggered when the action2 button is tapped.
       *
       * @event toast-action2
       */
    }
    customElements.define(AppToast.is, AppToast);
  </script>
</dom-module>
